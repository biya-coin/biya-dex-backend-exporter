groups:
  # ==========================================
  # 1. 区块链核心告警
  # ==========================================
  - name: blockchain_core_alerts
    interval: 30s
    rules:
      # 停止出块告警
      - alert: 停止出块
        expr: |
          (
            # 检查区块高度是否在5分钟内没有变化
            (changes(biya_chain_head_block_height[5m]) == 0)
            and
            (biya_chain_head_block_height > 0)
          )
          or
          (
            # 备用方案：使用biya_block_height
            (changes(biya_block_height[5m]) == 0)
            and
            (biya_block_height > 0)
          )
        for: 5m
        labels:
          severity: critical
          category: availability
          subsystem: consensus
        annotations:
          summary: "区块链停止出块"
          description: "最新区块超过5分钟未更新，链可能已停止运行"
          处理建议: |
            1. 立即检查所有验证者节点状态
            2. 查看网络连接是否正常
            3. 检查是否有共识问题
            4. 启动紧急恢复流程

      # 出块延迟告警
      - alert: 出块延迟
        expr: |
          (
            (biya_chain_block_time_seconds_avg or biya_block_time_seconds)
            > 
            ((avg_over_time(biya_chain_block_time_seconds_avg[1h]) or avg_over_time(biya_block_time_seconds[1h])) * 3)
          )
          and
          ((avg_over_time(biya_chain_block_time_seconds_avg[1h]) or avg_over_time(biya_block_time_seconds[1h])) > 0)
        for: 1m
        labels:
          severity: warning
          category: performance
          subsystem: consensus
        annotations:
          summary: "区块间隔异常延迟"
          description: "当前区块间隔 ({{ $value | humanize }}秒) 超过历史平均值的3倍"
          处理建议: |
            1. 检查验证者节点响应时间
            2. 查看网络延迟情况
            3. 分析是否有节点性能问题
            4. 评估是否需要替换验证者

      # 网络分叉告警
      - alert: 网络分叉
        expr: |
          # 注意：此指标需要从链监控工具获取，如果不存在则使用占位符
          (biya_chain_fork_depth or vector(0)) > 3
        for: 1m
        labels:
          severity: critical
          category: reliability
          subsystem: consensus
        annotations:
          summary: "检测到网络分叉"
          description: "检测到链分叉超过3个区块，可能存在严重共识问题"
          处理建议: |
            1. 立即通知技术团队
            2. 分析分叉原因
            3. 检查验证者投票情况
            4. 考虑暂停服务并协调修复

  # ==========================================
  # 2. 节点相关告警
  # ==========================================
  - name: node_related_alerts
    interval: 1m
    rules:
      # 验证者节点离线告警
      - alert: 验证者节点离线
        expr: |
          (
            (time() - biya_validator_last_active_timestamp) > 180
          )
          and
          (biya_validator_status == 1)
          and
          (biya_validator_last_active_timestamp > 0)
        for: 3m
        labels:
          severity: critical
          category: availability
          subsystem: validator
        annotations:
          summary: "验证者节点离线 - {{ $labels.moniker }}"
          description: "验证者节点 {{ $labels.moniker }} ({{ $labels.address }}) 超过3分钟无响应，最后活跃时间: {{ $value }}秒前"
          处理建议: |
            1. 立即检查该验证者节点状态
            2. 查看节点服务器是否正常运行
            3. 检查网络连接
            4. 查看节点日志排查问题

      # 大规模节点离线告警
      - alert: 大规模节点离线
        expr: |
          (
            (biya_validators_active or biya_stake_validators_bonded or vector(0))
            / 
            (biya_validators_total or biya_stake_validators_total or vector(1))
          ) < 0.7
        for: 1m
        labels:
          severity: critical
          category: availability
          subsystem: validator
        annotations:
          summary: "大规模节点离线"
          description: "超过30%的验证者节点同时离线，网络稳定性受到威胁"
          处理建议: |
            1. 立即启动应急预案
            2. 联系所有离线节点运营者
            3. 评估是否暂停服务
            4. 检查是否有网络攻击

      # 节点同步落后告警
      - alert: 节点同步落后
        expr: |
          (biya_node_behind_blocks or (biya_block_height - biya_node_sync_height)) > 100
        for: 10m
        labels:
          severity: warning
          category: performance
          subsystem: sync
        annotations:
          summary: "节点同步落后 - {{ $labels.node }}"
          description: "节点 {{ $labels.node }} 落后最新区块超过100个区块"
          处理建议: |
            1. 检查节点同步状态
            2. 查看节点性能是否正常
            3. 检查网络连接质量
            4. 评估是否需要重启节点

      # 节点同步异常慢告警
      - alert: 节点同步异常慢
        expr: |
          (
            rate(biya_node_sync_height[10m])
            <
            (rate(biya_block_height[10m]) * 0.5)
          )
          and
          (rate(biya_block_height[10m]) > 0)
        for: 10m
        labels:
          severity: warning
          category: performance
          subsystem: sync
        annotations:
          summary: "节点同步异常慢 - {{ $labels.node }}"
          description: "节点 {{ $labels.node }} 同步速度低于正常速度50%"
          处理建议: |
            1. 检查节点硬件资源使用情况
            2. 查看磁盘I/O性能
            3. 分析数据库性能
            4. 考虑优化节点配置或升级硬件

  # ==========================================
  # 3. 性能相关告警
  # ==========================================
  - name: performance_alerts
    interval: 30s
    rules:
      # TPS异常下降告警
      - alert: TPS异常下降
        expr: |
          (
            biya_tps_current 
            < 
            (avg_over_time(biya_tps_24h_avg[7d]) * 0.5)
          )
          and
          (
            avg_over_time(biya_tps_24h_avg[7d]) > 0
          )
        for: 5m
        labels:
          severity: warning
          category: performance
          subsystem: transaction
        annotations:
          summary: "TPS异常下降"
          description: "当前TPS ({{ $value | humanize }}) 低于历史7天平均值的50%，已持续超过5分钟"
          处理建议: |
            1. 检查节点运行状态
            2. 查看是否有网络分区
            3. 分析交易来源是否异常
            4. 必要时通知技术团队

      # 网络延迟过高告警
      - alert: 网络延迟过高
        expr: |
          (biya_tx_confirm_time_seconds_avg or biya_tx_confirm_time_avg_seconds) > 30
        for: 1m
        labels:
          severity: warning
          category: performance
          subsystem: latency
        annotations:
          summary: "网络延迟过高"
          description: "交易确认延迟 ({{ $value | humanize }}秒) 超过30秒，已持续超过1分钟"
          处理建议: |
            1. 检查交易池积压情况
            2. 查看Gas费用是否飙升
            3. 分析节点同步状态
            4. 评估是否需要临时扩容

      # 交易成功率低告警
      - alert: 交易成功率低
        expr: |
          biya_tx_success_rate < 0.90
        for: 5m
        labels:
          severity: critical
          category: reliability
          subsystem: transaction
        annotations:
          summary: "交易成功率低"
          description: "交易成功率 ({{ $value | humanizePercentage }}) 低于90%，已持续超过5分钟"
          处理建议: |
            1. 立即查看失败交易原因
            2. 检查是否有合约攻击
            3. 分析失败交易的共同特征
            4. 紧急处理高危问题

  # ==========================================
  # 4. Gas费用告警
  # ==========================================
  - name: gas_fee_alerts
    interval: 30s
    rules:
      # Gas价格飙升告警
      - alert: Gas价格飙升
        expr: |
          (
            biya_gas_price 
            > 
            (avg_over_time(biya_gas_price[24h]) * 2)
          )
          and
          (avg_over_time(biya_gas_price[24h]) > 0)
        for: 1m
        labels:
          severity: warning
          category: capacity
          subsystem: gas
        annotations:
          summary: "Gas价格飙升"
          description: "当前Gas价格 ({{ $value | humanize }} Gwei) 超过24小时平均值的2倍"
          处理建议: |
            1. 检查交易池拥堵情况
            2. 分析高Gas消耗的交易类型
            3. 评估是否需要提高Gas限制
            4. 通知用户Gas价格异常

      # 交易池拥堵告警
      - alert: 交易池拥堵
        expr: |
          (
            (biya_mempool_size or biya_chain_mempool_pending_txs or vector(0))
            /
            (biya_mempool_capacity or vector(5000))
          ) > 0.8
          or
          biya_congestion_ratio > 0.8
        for: 1m
        labels:
          severity: warning
          category: performance
          subsystem: mempool
        annotations:
          summary: "交易池拥堵"
          description: "交易池使用率超过80%，可能导致交易延迟"
          处理建议: |
            1. 分析交易池中的交易类型
            2. 检查是否有垃圾交易攻击
            3. 评估提高Gas费用阈值
            4. 考虑扩展节点处理能力

      # 交易池满载告警
      - alert: 交易池满载
        expr: |
          (
            (biya_mempool_size or biya_chain_mempool_pending_txs or vector(0))
            /
            (biya_mempool_capacity or vector(5000))
          ) > 0.95
          or
          biya_congestion_ratio > 0.95
        for: 1m
        labels:
          severity: critical
          category: capacity
          subsystem: mempool
        annotations:
          summary: "交易池满载"
          description: "交易池使用率超过95%，新交易可能无法进入交易池"
          处理建议: |
            1. 立即检查是否有恶意攻击
            2. 考虑提高Gas费用阈值
            3. 评估是否需要紧急扩容
            4. 通知用户交易可能被延迟

  # ==========================================
  # 5. 存储告警
  # ==========================================
  - name: storage_alerts
    interval: 1h
    rules:
      # 存储空间不足告警
      - alert: 存储空间不足
        expr: |
          # 注意：需要使用node_exporter的磁盘空间指标
          (1 - (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"})) > 0.90
          or
          # 如果有专门的区块链数据目录指标
          (biya_storage_usage_ratio or vector(0)) > 0.90
        for: 1h
        labels:
          severity: critical
          category: capacity
          subsystem: storage
        annotations:
          summary: "存储空间不足"
          description: "可用存储空间低于10%，可能导致节点无法正常运行"
          处理建议: |
            1. 立即清理不必要的日志文件
            2. 考虑启用数据归档
            3. 评估是否需要扩容存储
            4. 检查是否有异常数据增长

      # 存储空间预警告警
      - alert: 存储空间预警
        expr: |
          (1 - (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"})) > 0.80
          or
          (biya_storage_usage_ratio or vector(0)) > 0.80
        for: 1h
        labels:
          severity: warning
          category: capacity
          subsystem: storage
        annotations:
          summary: "存储空间预警"
          description: "可用存储空间低于20%，建议及时处理"
          处理建议: |
            1. 检查存储使用情况
            2. 规划存储扩容方案
            3. 清理临时文件和日志
            4. 考虑启用数据压缩

      # 存储增长过快告警
      - alert: 存储增长过快
        expr: |
          # 计算24小时存储增长量（GB）
          (
            (node_filesystem_size_bytes{mountpoint="/"} - node_filesystem_avail_bytes{mountpoint="/"})
            -
            (node_filesystem_size_bytes{mountpoint="/"} offset 24h - node_filesystem_avail_bytes{mountpoint="/"} offset 24h)
          ) / 1024 / 1024 / 1024 > 100
          or
          (biya_storage_daily_growth_gb or vector(0)) > 100
        for: 24h
        labels:
          severity: warning
          category: capacity
          subsystem: storage
        annotations:
          summary: "存储增长过快"
          description: "24小时存储增长超过100GB，可能存在异常"
          处理建议: |
            1. 分析存储增长来源
            2. 检查是否有异常数据写入
            3. 评估数据归档策略
            4. 规划长期存储扩容方案

  # ==========================================
  # 辅助规则：计算历史平均值和复合指标
  # ==========================================
  - name: recording_rules
    interval: 1m
    rules:
      # 记录7天TPS平均值，用于告警规则
      - record: biya_tps_7d_avg
        expr: avg_over_time(biya_tps_24h_avg[7d])

      # 记录TPS下降百分比
      - record: biya_tps_drop_percentage
        expr: |
          (
            (avg_over_time(biya_tps_24h_avg[7d]) - biya_tps_current) 
            / 
            avg_over_time(biya_tps_24h_avg[7d])
          ) * 100

      # 记录当前性能健康度评分 (0-100)
      - record: biya_performance_health_score
        expr: |
          (
            (
              clamp_min(biya_tps_current / avg_over_time(biya_tps_24h_avg[7d]), 0) * 30
            )
            +
            (
              clamp_max(1 - ((biya_tx_confirm_time_seconds_avg or biya_tx_confirm_time_avg_seconds) / 60), 1) * 30
            )
            +
            (
              biya_tx_success_rate * 40
            )
          ) * 100

      # 记录交易池使用率
      - record: biya_mempool_usage_ratio
        expr: |
          (biya_mempool_size or biya_chain_mempool_pending_txs or vector(0))
          /
          (biya_mempool_capacity or vector(5000))

      # 记录Gas价格倍数（相对于24h平均）
      - record: biya_gas_price_multiplier
        expr: |
          biya_gas_price 
          /
          (avg_over_time(biya_gas_price[24h]) + 0.0001)

  # ==========================================
  # 额外的综合告警（可选）
  # ==========================================
  - name: comprehensive_alerts
    interval: 30s
    rules:
      # 性能综合异常告警
      - alert: 性能综合异常告警
        expr: |
          (
            (
              biya_tps_current 
              < 
              (avg_over_time(biya_tps_24h_avg[7d]) * 0.5)
            )
            and
            (
              avg_over_time(biya_tps_24h_avg[7d]) > 0
            )
          )
          and
          (
            (biya_tx_confirm_time_seconds_avg or biya_tx_confirm_time_avg_seconds) > 30
          )
          and
          (
            biya_tx_success_rate < 0.90
          )
        for: 3m
        labels:
          severity: emergency
          category: incident
          subsystem: comprehensive
        annotations:
          summary: "性能综合异常 - 多个指标同时异常"
          description: |
            检测到多个性能指标同时异常：
            - TPS: {{ with query "biya_tps_current" }}{{ . | first | value | humanize }}{{ end }}
            - 延迟: {{ with query "biya_tx_confirm_time_seconds_avg" }}{{ . | first | value | humanize }}秒{{ end }}
            - 成功率: {{ with query "biya_tx_success_rate" }}{{ . | first | value | humanizePercentage }}{{ end }}
          处理建议: |
            1. 立即启动应急预案
            2. 召集技术团队会商
            3. 全面排查网络问题
            4. 必要时暂停服务维护
          runbook_url: "https://docs.biya.chain/runbooks/emergency-response"
          dashboard: "https://grafana.biya.chain/d/chain-performance"
          page_team: "oncall"

      # TPS完全停止告警
      - alert: TPS完全停止
        expr: |
          biya_tps_current == 0
        for: 2m
        labels:
          severity: critical
          category: availability
          subsystem: transaction
        annotations:
          summary: "TPS为零 - 链可能已停止出块"
          description: "当前TPS为0，持续超过2分钟，链可能已停止运行"
          处理建议: |
            1. 立即检查节点状态
            2. 查看是否所有验证者都离线
            3. 检查网络连接
            4. 启动紧急恢复流程
