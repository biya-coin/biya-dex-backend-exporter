# å‘Šè­¦è§„åˆ™å¿«é€Ÿå‚è€ƒå¡ç‰‡

## æ ¸å¿ƒå‘Šè­¦è§„åˆ™ä¸€è§ˆ

### ğŸ”´ ç´§æ€¥å‘Šè­¦ï¼ˆEmergencyï¼‰

| å‘Šè­¦åç§° | è§¦å‘æ¡ä»¶ | æŒç»­æ—¶é—´ | è¯´æ˜ |
|---------|---------|---------|------|
| **PerformanceComprehensiveAbnormal** | TPS<50%å†å²å‡å€¼ AND å»¶è¿Ÿ>10s AND æˆåŠŸç‡<98% | 3åˆ†é’Ÿ | å¤šæŒ‡æ ‡åŒæ—¶å¼‚å¸¸ |

**å¤„ç†æµç¨‹**ï¼š
1. ç«‹å³å¯åŠ¨åº”æ€¥é¢„æ¡ˆ
2. å¬é›†æŠ€æœ¯å›¢é˜Ÿä¼šå•†
3. å…¨é¢æ’æŸ¥ç½‘ç»œé—®é¢˜
4. å¿…è¦æ—¶æš‚åœæœåŠ¡ç»´æŠ¤

---

### ğŸŸ  ä¸¥é‡å‘Šè­¦ï¼ˆCriticalï¼‰

| å‘Šè­¦åç§° | è§¦å‘æ¡ä»¶ | æŒç»­æ—¶é—´ | è¯´æ˜ |
|---------|---------|---------|------|
| **TransactionSuccessRateDrop** | æˆåŠŸç‡ < 98% | 5åˆ†é’Ÿ | äº¤æ˜“æˆåŠŸç‡ä¸‹é™ |
| **TPSZero** | TPS = 0 | 2åˆ†é’Ÿ | é“¾å¯èƒ½åœæ­¢å‡ºå— |

**å¤„ç†æµç¨‹**ï¼š
1. ç«‹å³æŸ¥çœ‹å¤±è´¥äº¤æ˜“åŸå› 
2. æ£€æŸ¥æ˜¯å¦æœ‰åˆçº¦æ”»å‡»
3. åˆ†æå¤±è´¥äº¤æ˜“çš„å…±åŒç‰¹å¾
4. ç´§æ€¥å¤„ç†é«˜å±é—®é¢˜

---

### ğŸŸ¡ è­¦å‘Šå‘Šè­¦ï¼ˆWarningï¼‰

| å‘Šè­¦åç§° | è§¦å‘æ¡ä»¶ | æŒç»­æ—¶é—´ | è¯´æ˜ |
|---------|---------|---------|------|
| **TPSAbnormalDrop** | TPS < 50%å†å²å¹³å‡å€¼ | 5åˆ†é’Ÿ | TPSå¼‚å¸¸ä¸‹é™ |
| **NetworkLatencyAbnormalIncrease** | å»¶è¿Ÿ > 10ç§’ | 10åˆ†é’Ÿ | ç½‘ç»œå»¶è¿Ÿå¼‚å¸¸ |
| **MempoolCongestion** | å¾…å¤„ç†äº¤æ˜“ > 10000 | 5åˆ†é’Ÿ | äº¤æ˜“æ± æ‹¥å µ |
| **HighGasUtilization** | Gasåˆ©ç”¨ç‡ > 95% | 10åˆ†é’Ÿ | Gasåˆ©ç”¨ç‡è¿‡é«˜ |
| **BlockTimeAbnormal** | å‡ºå—æ—¶é—´ > 10ç§’ | 5åˆ†é’Ÿ | å‡ºå—æ—¶é—´å¼‚å¸¸ |
| **NetworkCongestion** | æ‹¥å µæŒ‡æ•° > 80% | 5åˆ†é’Ÿ | ç½‘ç»œæ‹¥å µ |

**å¤„ç†æµç¨‹**ï¼š
- æ£€æŸ¥èŠ‚ç‚¹è¿è¡ŒçŠ¶æ€
- æŸ¥çœ‹ç½‘ç»œåˆ†åŒºæƒ…å†µ
- åˆ†æäº¤æ˜“æ¥æº
- è¯„ä¼°æ˜¯å¦éœ€è¦æ‰©å®¹

---

## å¿«é€Ÿå‘½ä»¤

### æŸ¥çœ‹å‘Šè­¦çŠ¶æ€

```bash
# æŸ¥çœ‹æ‰€æœ‰æ´»è·ƒå‘Šè­¦
curl http://localhost:9090/api/v1/alerts | jq '.data.alerts[] | select(.state=="firing")'

# æŸ¥çœ‹ç‰¹å®šå‘Šè­¦
curl "http://localhost:9090/api/v1/alerts" | jq '.data.alerts[] | select(.labels.alertname=="TPSAbnormalDrop")'

# ä½¿ç”¨æµ‹è¯•è„šæœ¬
./scripts/test_alerts.sh
```

### é™é»˜å‘Šè­¦

```bash
# é™é»˜ 2 å°æ—¶
amtool silence add alertname=TPSAbnormalDrop --duration=2h --comment="ç»´æŠ¤çª—å£"

# æŸ¥çœ‹æ‰€æœ‰é™é»˜
amtool silence query

# åˆ é™¤é™é»˜
amtool silence expire <silence-id>
```

### æµ‹è¯•å‘Šè­¦

```bash
# éªŒè¯è§„åˆ™è¯­æ³•
promtool check rules configs/prometheus/alert_rules.yml

# æµ‹è¯• PromQL è¡¨è¾¾å¼
curl "http://localhost:9090/api/v1/query?query=biya_tps_current"

# é‡æ–°åŠ è½½é…ç½®
curl -X POST http://localhost:9090/-/reload
```

---

## å…³é”®æŒ‡æ ‡å¿«æŸ¥

| æŒ‡æ ‡åç§° | ç±»å‹ | è¯´æ˜ | æ­£å¸¸èŒƒå›´ |
|---------|------|------|---------|
| `biya_tps_current` | Gauge | å½“å‰TPS | > å†å²å‡å€¼çš„50% |
| `biya_tps_24h_avg` | Gauge | 24å°æ—¶å¹³å‡TPS | - |
| `biya_tx_success_rate` | Gauge | äº¤æ˜“æˆåŠŸç‡ | > 0.98 (98%) |
| `biya_tx_confirm_time_seconds_avg` | Gauge | å¹³å‡ç¡®è®¤å»¶è¿Ÿ | < 10ç§’ |
| `biya_chain_mempool_pending_txs` | Gauge | å¾…å¤„ç†äº¤æ˜“æ•° | < 10000 |
| `biya_chain_block_gas_utilization_ratio_avg` | Gauge | Gasåˆ©ç”¨ç‡ | < 0.95 (95%) |
| `biya_chain_congestion_ratio` | Gauge | æ‹¥å µæŒ‡æ•° | < 0.8 (80%) |
| `biya_chain_block_time_seconds_avg` | Gauge | å¹³å‡å‡ºå—æ—¶é—´ | < 10ç§’ |

---

## å‘Šè­¦çº§åˆ«è¯´æ˜

| çº§åˆ« | å“åº”æ—¶é—´ | é€šçŸ¥æ–¹å¼ | å…¸å‹åœºæ™¯ |
|------|---------|---------|---------|
| ğŸ”´ **Emergency** | ç«‹å³ | ç”µè¯+çŸ­ä¿¡+IM+é‚®ä»¶ | ç³»ç»Ÿçº§æ•…éšœ |
| ğŸŸ  **Critical** | < 5åˆ†é’Ÿ | çŸ­ä¿¡+IM+é‚®ä»¶ | å…³é”®åŠŸèƒ½å¼‚å¸¸ |
| ğŸŸ¡ **Warning** | < 30åˆ†é’Ÿ | IM+é‚®ä»¶ | æ€§èƒ½ä¸‹é™ |
| ğŸ”µ **Info** | < 2å°æ—¶ | é‚®ä»¶ | ä¸€èˆ¬æ€§é€šçŸ¥ |

---

## å¸¸ç”¨ PromQL è¡¨è¾¾å¼

```promql
# æŸ¥è¯¢å½“å‰ TPS
biya_tps_current

# æŸ¥è¯¢ 7 å¤©å¹³å‡ TPS
avg_over_time(biya_tps_24h_avg[7d])

# è®¡ç®— TPS ä¸‹é™ç™¾åˆ†æ¯”
((avg_over_time(biya_tps_24h_avg[7d]) - biya_tps_current) / avg_over_time(biya_tps_24h_avg[7d])) * 100

# æŸ¥è¯¢è¿‡å» 1 å°æ—¶çš„æˆåŠŸç‡
avg_over_time(biya_tx_success_rate[1h])

# æŸ¥è¯¢è¿‡å» 5 åˆ†é’Ÿçš„äº¤æ˜“å¢é•¿ç‡
rate(biya_tx_total[5m])

# æ£€æŸ¥æŒ‡æ ‡æ˜¯å¦ç¼ºå¤±
absent(biya_tps_current)
```

---

## Web UI è®¿é—®

| æœåŠ¡ | åœ°å€ | è¯´æ˜ |
|------|------|------|
| **Prometheus** | http://localhost:9090 | ä¸»ç•Œé¢ |
| **å‘Šè­¦é¡µé¢** | http://localhost:9090/alerts | æŸ¥çœ‹æ‰€æœ‰å‘Šè­¦è§„åˆ™å’ŒçŠ¶æ€ |
| **è§„åˆ™é¡µé¢** | http://localhost:9090/rules | æŸ¥çœ‹æ‰€æœ‰è§„åˆ™ï¼ˆå‘Šè­¦+è®°å½•ï¼‰ |
| **ç›®æ ‡é¡µé¢** | http://localhost:9090/targets | æŸ¥çœ‹é‡‡é›†ç›®æ ‡çŠ¶æ€ |
| **Alertmanager** | http://localhost:9093 | å‘Šè­¦ç®¡ç†å’Œé™é»˜ |

---

## æ•…éšœæ’æŸ¥æ£€æŸ¥æ¸…å•

### âŒ å‘Šè­¦æœªè§¦å‘

- [ ] è¡¨è¾¾å¼æ˜¯å¦æ­£ç¡®ï¼Ÿâ†’ åœ¨ Prometheus UI ä¸­æµ‹è¯•
- [ ] æ•°æ®æ˜¯å¦å­˜åœ¨ï¼Ÿâ†’ æŸ¥è¯¢åŸºç¡€æŒ‡æ ‡
- [ ] æŒç»­æ—¶é—´æ˜¯å¦å¤ªé•¿ï¼Ÿâ†’ æ£€æŸ¥ `for` å­—æ®µ
- [ ] è§„åˆ™æ˜¯å¦å·²åŠ è½½ï¼Ÿâ†’ è®¿é—® `/rules` é¡µé¢
- [ ] Alertmanager æ˜¯å¦è¿æ¥ï¼Ÿâ†’ è®¿é—® `/alertmanagers` é¡µé¢

### âŒ é€šçŸ¥æœªæ”¶åˆ°

- [ ] Alertmanager æ˜¯å¦è¿è¡Œï¼Ÿâ†’ `curl http://localhost:9093/-/healthy`
- [ ] è·¯ç”±é…ç½®æ˜¯å¦æ­£ç¡®ï¼Ÿâ†’ æ£€æŸ¥ `alertmanager.yml` ä¸­çš„ `route`
- [ ] æ¥æ”¶è€…é…ç½®æ˜¯å¦æ­£ç¡®ï¼Ÿâ†’ æ£€æŸ¥ `receivers` é…ç½®
- [ ] æ˜¯å¦è¢«é™é»˜ï¼Ÿâ†’ `amtool silence query`
- [ ] æ˜¯å¦è¢«æŠ‘åˆ¶ï¼Ÿâ†’ æ£€æŸ¥ `inhibit_rules`

### âŒ å‘Šè­¦å¤ªå¤šï¼ˆå‘Šè­¦ç–²åŠ³ï¼‰

- [ ] é˜ˆå€¼æ˜¯å¦è¿‡äºæ•æ„Ÿï¼Ÿâ†’ è°ƒæ•´è¡¨è¾¾å¼ä¸­çš„é˜ˆå€¼
- [ ] æŒç»­æ—¶é—´æ˜¯å¦å¤ªçŸ­ï¼Ÿâ†’ å¢åŠ  `for` æ—¶é—´
- [ ] æ˜¯å¦éœ€è¦èšåˆï¼Ÿâ†’ é…ç½®å‘Šè­¦åˆ†ç»„
- [ ] é‡å¤é—´éš”æ˜¯å¦å¤ªçŸ­ï¼Ÿâ†’ è°ƒæ•´ `repeat_interval`

---

## è”ç³»æ–¹å¼

| åœºæ™¯ | è”ç³»æ–¹å¼ |
|------|---------|
| ç´§æ€¥æ•…éšœ | oncall@biya.chain |
| è¿ç»´æ”¯æŒ | ops@biya.chain |
| æŠ€æœ¯æ”¯æŒ | support@biya.chain |

---

## ç›¸å…³æ–‡æ¡£

- ğŸ“– [å®Œæ•´é…ç½®æ–‡æ¡£](./README.md)
- ğŸ“– [å‘Šè­¦è§„åˆ™ç¼–å†™æŒ‡å—](./ALERT_RULES_GUIDE.md)
- ğŸ“– [å˜æ›´æ—¥å¿—](../../CHANGELOG_ALERTS.md)
- ğŸ“– [äº§å“éœ€æ±‚æ–‡æ¡£](../../å…¬é“¾åå°éœ€æ±‚/å…¬é“¾åå°ç®¡ç†ç³»ç»Ÿéœ€æ±‚æ–‡æ¡£%20-%20è¿è¡ŒçŠ¶æ€ç›‘æ§.md)

---

**æœ€åæ›´æ–°**: 2025-12-24

